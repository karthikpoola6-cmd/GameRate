# Session 012 - January 30, 2026

## Summary
Added custom backdrop selection feature and various UI refinements.

## Changes Made

### Custom Backdrop Selection
- Added 3 dots menu in top-right of game page backdrop (Letterboxd style)
- Created `/game/[slug]/backdrop` page for selecting custom backdrops
- Users can choose from IGDB screenshots and save their selection
- Selection stored in `custom_backdrop_id` field in `game_logs` table
- Cancel uses `router.back()`, Save uses `router.replace()` to avoid backdrop page in history

### Back Button Positioning
- Moved back button to top-3 left-3 (aligned with 3 dots on opposite side)
- Clean positioning similar to Letterboxd UI

### Profile Page Layout
- Moved rating histogram inside "Recent Ratings" section
- Layout now: Top 5 → Recent Ratings header → Histogram → Game posters
- Aligned "Favorite Games" and "Recent Ratings" headers (same font, same spacing mb-6)
- Added gold border (`ring-2 ring-gold/50`) to profile avatar matching Top 5 games

### Code Cleanup
- Removed unused `IGDBGame` type import from game page
- Added `custom_backdrop_id` to GameLog type in types.ts

## Files Modified
- `src/app/game/[slug]/page.tsx` - Added 3 dots menu and custom backdrop display
- `src/app/game/[slug]/backdrop/page.tsx` - New backdrop selection page (server)
- `src/app/game/[slug]/backdrop/BackdropSelector.tsx` - New backdrop selector (client)
- `src/app/user/[username]/page.tsx` - Profile layout changes, gold avatar border
- `src/components/BackButton.tsx` - Repositioned to top-3 left-3
- `src/lib/types.ts` - Added custom_backdrop_id field

## Database
- Uses existing `custom_backdrop_id` column in `game_logs` table (already in DB)

## Commits
- `0a90e9e` - Add custom backdrop selection and profile layout improvements
- `07f0379` - Add gold border to profile avatar

## Notes
- All images use `unoptimized` prop to avoid Vercel image optimization costs
- Backdrop page reuses cached IGDB data (no extra API calls)
- 3 dots only visible when user has game logged AND multiple screenshots exist

---

## Session 012 Continued - January 31, 2026

### Bug Fixes

#### Profile "User Not Found" Bug
- **Problem**: New users could sign up but got "user not found" when viewing profile
- **Cause**: Case sensitivity mismatch - usernames stored with mixed case but looked up with `.toLowerCase()`
- **Fix**:
  - Store usernames as lowercase in `setup-username/page.tsx`
  - Use `.ilike()` for case-insensitive lookups across all profile pages
- **Files**: All `user/[username]/*.tsx` pages updated

#### Recent Ratings Order Bug
- **Problem**: Changing backdrop bumped game to top of Recent Ratings
- **Cause**: Recent Ratings ordered by `updated_at` (any change)
- **Fix**: Added `rated_at` column, ordered by when rating was set
- **Migration**: `004_add_rated_at.sql` - new column + triggers
- **Files**: `user/[username]/page.tsx`, `user/[username]/games/page.tsx`

### New Features

#### Friend Activity Ordering
- Changed friend activity to order by most recent rating (not any update)
- Only shows friends' rated games, not other activity
- **Migration**: `005_update_friend_activity.sql` - updated RPC function
- **File**: `src/components/ActivityFeed.tsx`

#### Avatar Storage Optimization
- **Problem**: Old profile pics accumulated in Supabase storage
- **Fix**: Use fixed filename `{userId}.jpg` - new uploads overwrite old
- Added cache buster to force browser refresh
- Added UPDATE policy to Supabase Storage bucket
- **File**: `src/app/settings/profile/page.tsx`

### Dead Code Removal
- Removed `src/components/ui/skeleton.tsx` (unused)
- Removed `tmp/` directory

### Commits
- `70069b5` - Fix profile lookup and rating order, remove dead code
- `76470dd` - Use fixed filename for avatars to prevent orphaned files
- `fdd2215` - Order friend activity by most recent rating

### Database Changes (run in Supabase)
1. `rated_at` column + triggers (already applied)
2. `get_friend_activity` function update (already applied)
3. Storage UPDATE policy for Avatars bucket (already applied)

### Known Issues Identified (Not Fixed)
- `CreateListForm.tsx:149` - Cancel goes to "/" instead of user's lists
- `BackButton.tsx` - No fallback if `router.back()` exits app
- `ListViewClient.tsx` - Silent DB failures on save
- `FavoriteGames.tsx` - Optimistic updates without rollback

---

## Session 012 Continued - January 31, 2026 (Part 2)

### Open Graph Image for Social Sharing

#### Problem
- Sharing GameRate link on LinkedIn showed Elden Ring screenshot (from cached/old data)
- Wanted the GameRate crystal logo to appear in social previews

#### Solution - Static OG Image
- Initially tried dynamic OG image with `next/og` ImageResponse - was blurry on LinkedIn
- Created static 1200x630 PNG image instead for best quality
- Added script `scripts/generate-og-image.mjs` to regenerate if needed

#### Implementation
1. Created Sharp-based script to generate OG image:
   - Fetches GameRate.png crystal logo
   - Removes black background by making dark pixels transparent
   - Composites onto dark gradient background
   - Adds "GameRate" text with purple-to-gold gradient
2. Final design: Just crystal logo + "GameRate" text, centered
3. Added cache-busting parameter `?v=2` to force LinkedIn refresh

#### Files
- `public/og-image.png` - Static OG image (1200x630)
- `scripts/generate-og-image.mjs` - Generation script
- `src/app/layout.tsx` - Updated metadata with explicit image URLs
- `src/app/opengraph-image.tsx` - Deleted (replaced with static image)

### Additional Dead Code Removal
- Removed `src/components/UserMenu.tsx` - 112 lines, unused (SettingsMenu used instead)
- Fixed invalid CSS class `gap-2/40` → `gap-2` in FavoriteGames.tsx

### Commits
- `2ed87c1` - Use actual GameRate crystal logo in OG image
- `c7c6c6e` - Replace dynamic OG image with high-quality static version
- `c73ea0c` - Simplify OG image - centered crystal, title, and tagline
- `766fdec` - Minimal OG image - crystal and GameRate only
- `7156650` - Add cache-busting param to OG image URL
- `ac1e329` - Remove dead code

### Notes
- LinkedIn caches OG images aggressively - use Post Inspector to refresh
- Cache-busting param `?v=2` doesn't affect Vercel usage (static file served from CDN)
- To regenerate OG image: `node scripts/generate-og-image.mjs`
